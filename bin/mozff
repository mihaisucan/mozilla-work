#!/bin/bash

# This script allows me to start the mozilla build from my cloned repo.

MY_DIR="$( cd -P "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$MY_DIR/_mozinclude"

gdb=n
dbg=n
b2g=n

for i do
  case $i in
    ('-gdb')
      gdb=y
      dbg=y
      ;;
    ('-dbg')
      dbg=y
      ;;
    ('-b2g')
      b2g=y
      ;;
  esac
done

if [[ ! -d "$CFG_BUILDS_DIR" ]]
then
  echo "folder not found: $CFG_BUILDS_DIR"
  exit 1
fi

if [[ "$b2g" == "y" ]]
then
  app="b2g"
else
  app="browser"
fi

if [[ "$dbg" == "y" ]]
then
  ffdir="$CFG_BUILDS_DIR/$MY_REPO_NAME/$app-dbg/dist"
else
  ffdir="$CFG_BUILDS_DIR/$MY_REPO_NAME/$app-opt/dist"
fi

if [[ ! -d "$ffdir" ]]
then
  echo "folder not found: $ffdir"
  exit 1
fi

cd "$ffdir"

if [[ "$b2g" == "y" ]]
then
  if [[ "$MY_OS" == "Darwin" ]]
  then
    cmd="B2G.app/Contents/MacOS/b2g"
  else
    cmd="./bin/b2g"
  fi
else
  if [[ "$MY_OS" == "Darwin" ]]
  then
    if [[ "$dbg" == "y" ]]
    then
      cmd="NightlyDebug.app/Contents/MacOS/firefox"
    else
      cmd="Nightly.app/Contents/MacOS/firefox"
    fi
  elif [[ "$MY_OS" == "mswin" ]]
  then
    cmd="bin/firefox.exe"
  else
    cmd="./bin/firefox"
  fi
fi

cmd="$cmd -no-remote"

if [[ "$gdb" == "y" ]]
then
  cmd="$cmd -g"
fi

profile="-P mozilla-central"

if [[ "$b2g" == "y" ]]
then
  profile="-profile $CFG_GAIA_PROFILE"
  export DEBUG=1
fi

cmd="$cmd $profile -purgecaches"

if [[ "$b2g" == "y" ]]
then
  cmd="$cmd -jsconsole http://system.gaiamobile.org:8080"
fi

echo "$cmd";
echo;
$cmd
echo "Firefox ran for $SECONDS seconds."
