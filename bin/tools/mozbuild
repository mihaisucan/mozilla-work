#!/bin/bash

# Quickly start dbg/opt mozilla firefox builds.

MY_SELF="${0##*/}"
MY_DIR="$( cd -P "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "$MY_DIR/../../config.local"

dbg=0
clobber=0
configure=0
both=0
argslist=""
for i do
  case $i in
    ('-dbg')
      dbg=1
      ;;
    ('-clobber')
      clobber=1
      arglist="$i $argslist"
      ;;
    ('-configure')
      configure=1
      arglist="$i $argslist"
      ;;
    ('-both')
      both=1
      ;;
  esac
done

if [[ "$both" -eq 1 ]]
then
  $MY_SELF $argslist
  $MY_SELF -dbg $argslist
  exit $?
fi

if [[ ! -d "$CFG_BUILDS_DIR" ]]
then
  echo "folder not found: $CFG_BUILDS_DIR"
  exit 1
fi

if [[ "$CFG_BUILD_CLANG" -eq 1 ]]
then
  export CC='clang -Qunused-arguments -fcolor-diagnostics -w'
  export CXX='clang++ -Qunused-arguments -fcolor-diagnostics -w'
fi

if [[ ! -f client.mk ]]
then
  echo "file not found: client.mk"
  exit 1
fi

if [[ ! -d "$CFG_BUILDS_DIR" ]]
then
  echo "folder not found: $CFG_BUILDS_DIR"
  exit
fi

export MOZ_OBJDIR="$CFG_BUILDS_DIR/$MY_SRC_DIR"

if [[ ! -d "$MOZ_OBJDIR" ]]
then
  mkdir "$MOZ_OBJDIR"
fi

if [[ $dbg -eq 1 ]]
then
  buildtype="dbg"
else
  buildtype="opt"
fi

export MOZ_OBJDIR="$CFG_BUILDS_DIR/$MY_SRC_DIR/$buildtype"
export MOZCONFIG="$MY_DIR/../../mozconfig/$buildtype"

if [[ ! -f "$MOZCONFIG" ]]
then
  echo "file not found: $MOZCONFIG"
  exit 1
fi

if [[ $clobber -eq 1 ]]
then
  rm -r "$MOZ_OBJDIR"
  echo "Build $buildtype clobbered, removed $MOZ_OBJDIR"
  exit 0
fi

if [[ $configure -eq 1 ]]
then
  make -f client.mk configure
fi

make -f client.mk build

if [[ "$?" -eq 0 ]]
then
  msg="Firefox build $buildtype ready. It took $SECONDS seconds"
  notify-send "$MY_SELF" "$msg" -i "info" -u "low"
else
  msg="Firefox build $buildtype failed. It took $SECONDS seconds"
  notify-send "$MY_SELF" "$msg" -i "error" -u "critical"
fi

echo "$msg";
